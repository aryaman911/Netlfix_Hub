<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Home</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">MOVIEHUB</div>
        <div class="nav-links">
            <a href="home.html" class="nav-link active">Home</a>
            <a href="watchlist.html" class="nav-link">My List</a>
            <a href="admin.html" class="nav-link" id="nav-admin" style="display:none;">Admin</a>
        </div>
        <div class="nav-user">
            <span class="nav-username" id="nav-username">User</span>
            <button class="btn btn-outline btn-small" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <div class="filters">
            <input type="text" id="search-input" placeholder="Search series...">
            <select id="genre-filter">
                <option value="">All Genres</option>
            </select>
            <select id="language-filter">
                <option value="">All Languages</option>
            </select>
            <button class="btn btn-secondary" onclick="searchSeries()">Search</button>
        </div>

        <h2 class="section-title">All Series</h2>
        <div class="series-grid" id="series-grid">
            <div class="loading">Loading...</div>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check login
        if (!isLoggedIn()) {
            window.location.href = 'index.html';
        }

        // Show admin link if admin
        if (isAdmin()) {
            document.getElementById('nav-admin').style.display = 'inline';
        }

        // Set username
        document.getElementById('nav-username').textContent = getUsername();

        // Load data
        loadFilters();
        loadSeries();

        // Enter key search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchSeries();
        });

        async function loadFilters() {
            try {
                const [genres, languages] = await Promise.all([
                    apiRequest('/reference/genres'),
                    apiRequest('/reference/languages')
                ]);

                const genreSelect = document.getElementById('genre-filter');
                genres.forEach(g => {
                    genreSelect.innerHTML += '<option value="' + g.type_code + '">' + g.type_name + '</option>';
                });

                const langSelect = document.getElementById('language-filter');
                languages.forEach(l => {
                    langSelect.innerHTML += '<option value="' + l.language_code + '">' + l.language_name + '</option>';
                });
            } catch (err) {
                console.error('Failed to load filters:', err);
            }
        }

        async function loadSeries(search, genre, language) {
            const grid = document.getElementById('series-grid');
            grid.innerHTML = '<div class="loading">Loading...</div>';

            try {
                let url = '/series';
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (genre) params.append('genre', genre);
                if (language) params.append('language', language);
                if (params.toString()) url += '?' + params.toString();

                const series = await apiRequest(url);

                if (!series.length) {
                    grid.innerHTML = '<div class="empty-state">No series found</div>';
                    return;
                }

                grid.innerHTML = series.map(function(s) {
                    return '<div class="series-card" onclick="window.location.href=\'series.html?id=' + s.series_id + '\'">' +
                        '<img src="' + (s.poster_url || CONFIG.PLACEHOLDER_IMAGE) + '" onerror="this.src=\'' + CONFIG.PLACEHOLDER_IMAGE + '\'" alt="' + s.name + '">' +
                        '<div class="series-card-info">' +
                            '<div class="series-card-title">' + s.name + '</div>' +
                            '<div class="series-card-meta">' +
                                '<span>' + (s.maturity_rating || 'NR') + '</span>' +
                                '<span class="series-card-rating">' + (s.avg_rating ? 'â˜… ' + s.avg_rating.toFixed(1) : '') + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (err) {
                grid.innerHTML = '<div class="empty-state">Failed to load: ' + err.message + '</div>';
            }
        }

        function searchSeries() {
            loadSeries(
                document.getElementById('search-input').value,
                document.getElementById('genre-filter').value,
                document.getElementById('language-filter').value
            );
        }
    </script>
</body>
</html>
